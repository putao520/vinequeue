# VineQueue 变更日志

**版本**: v2.0.0
**类型**: 工具类库
**状态**: ✅ 完成
**创建日期**: 2025-12-23
**维护者**: VineRoute Backend Team

---

## 版本说明

本文档记录了VineQueue的所有版本变更，包括新功能、修复改进和API变更。

---

## v2.0.0 (2025-12-23)

### 🎉 重大更新 - Per-Goroutine Buffer架构

#### 新增功能

- ✅ **Per-Goroutine Buffer架构**
  - 零竞争本地缓冲区，支持278M ops/s并发性能
  - 每个goroutine独立buffer，无锁写入
  - 支持泛型T，类型安全队列

- ✅ **自适应批量策略**
  - 根据下游延迟动态调整批量大小
  - 支持MinBatchSize (100) → MaxBatchSize (5000)
  - 智能性能优化，保持吞吐量和延迟平衡

- ✅ **WAL持久化增强**
  - 支持Write-Ahead Log保证数据安全
  - 断电不丢数据，启动时自动恢复
  - 可配置同步模式（immediate/periodic）
  - 支持大文件（最大1GB）

- ✅ **OOM保护机制**
  - 80%软限制：警告+1ms延迟
  - 95%硬限制：拒绝写入或降级WAL
  - 分级背压，保护系统稳定性

#### 性能优化

- ⚡ **入队延迟优化**
  - 快速路径：<10ns入队时间
  - 慢速路径：<1ms聚合时间
  - 零内存分配（热路径）

- ⚡ **内存使用优化**
  - 43 B/op内存占用
  - 0 allocs/op（零分配）
  - 本地缓冲区预分配

- ⚡ **并发性能提升**
  - 支持20核并发278M ops/s
  - 无锁设计，支持高并发
  - 分片负载均衡

#### API改进

- 📦 **简洁的泛型API**
  - 支持任意Go类型 `Queue[T any]`
  - 类型安全的编译时检查
  - 一致的接口设计

- 📦 **配置系统优化**
  - 支持JSON/YAML配置
  - 丰富的配置工厂函数
  - 自动配置验证

#### 错误处理

- 🐛 **增强的错误处理**
  - 详细的错误类型定义
  - 智能重试机制
  - 完整的错误日志

- 🐛 **优雅关闭**
  - 确保所有数据发送完成
  - 自动WAL清理
  - 资源释放保证

#### 监控和指标

- 📊 **实时监控指标**
  - 队列使用率、吞吐量、延迟
  - 溢出计数、告警信息
  - 可选的Prometheus支持

- 📊 **性能基准测试**
  - 详细的性能基准数据
  - 压力测试报告
  - 性能调优指南

#### 文档和示例

- 📚 **完整文档**
  - API详细说明
  - 架构设计文档
  - 使用最佳实践

- 📚 **丰富示例**
  - 基础使用示例
  - 高级场景示例
  - 多种后端集成示例

---

## v1.2.0 (2025-10-15)

### 功能增强

- 🔧 **批量发送优化**
  - 支持批量入队 `EnqueueBatch()`
  - 批量大小配置优化
  - 批量错误处理改进

- 🔧 **重试机制**
  - 可配置重试次数
  - 指数退避策略
  - 错误分类处理

- 🔧 **监控增强**
  - 新增队列深度指标
  - 发送延迟监控
  - 错误率统计

#### Bug修复

- 🐛 **内存泄漏修复**
  - 修复长期运行时的内存增长
  - 优化缓冲区回收机制

- 🐛 **并发安全修复**
  - 修复多goroutine竞争条件
  - 改进锁粒度

---

## v1.1.0 (2025-08-20)

### 新增功能

- 🆕 **WAL持久化**
  - 基础的磁盘持久化功能
  - 启动时数据恢复
  - 文件大小限制

- 🆕 **配置文件支持**
  - 支持JSON配置
  - 环境变量覆盖
  - 配置验证

#### API变更

- 🔄 **配置结构重构**
  - 新增 `Config` 结构
  - 移除全局配置
  - 支持自定义配置

- 🔄 **工厂函数**
  - 添加 `NewWithConfig()`
  - 简化初始化流程

---

## v1.0.0 (2025-06-01)

### 初始版本

- 🎯 **基础队列功能**
  - 简单的内存队列实现
  - 基本的入队/出队操作
  - 固定批量大小

- 🎯 **并发安全**
  - 基本的互斥锁保护
  - 简单的并发控制

#### 限制

- ❌ 不支持泛型
- ❌ 无WAL持久化
- ❌ 简单的错误处理
- ❌ 性能一般

---

## 版本迁移指南

### v1.x → v2.0.0 迁移

#### 1. API变更

```go
// 旧API (v1.x)
queue := vinequeue.NewQueue()
queue.Enqueue(item)

// 新API (v2.0.0)
config := vinequeue.DefaultConfig()
queue, err := vinequeue.New[MyType](config, sendFunc)
```

#### 2. 配置变更

```go
// 旧配置方式
vinequeue.SetBatchSize(1000)

// 新配置方式
config := vinequeue.DefaultConfig()
config.BatchSize = 1000
```

#### 3. 发送函数

```go
// 新增发送函数要求
sendFunc := func(ctx context.Context, batch []MyType) error {
    // 批量处理逻辑
    return nil
}
```

#### 4. 启动/停止

```go
// 新增生命周期管理
err := queue.Start(context.Background())
defer queue.Stop()
```

---

## 废弃计划

### v2.x 废弃计划

| 功能 | 废弃版本 | 替代方案 | 说明 |
|------|----------|----------|------|
| 全局配置函数 | v2.1.0 | Config结构 | 迁移到配置结构 |
| 简单入队API | v2.1.0 | 带类型泛型API | 提供类型安全 |
| 同步发送模式 | v2.2.0 | 异步批量发送 | 提高性能 |

### v3.0 计划

- 🚀 **分布式支持**
  - 多实例协同工作
  - 跨节点数据同步
  - 分布式WAL

- 🚀 **云原生集成**
  - Kubernetes支持
  - 服务网格集成
  - 云监控集成

- 🚀 **高级功能**
  - 事件流处理
  - 复杂路由规则
  - 实时 analytics

---

## 兼容性说明

### 向后兼容性

- ✅ **v2.0.0 与 v1.x 不兼容**
  - 完全重写了API
  - 新增泛型支持
  - 架构大幅优化

- ✅ **v2.x 内部兼容**
  - 保证API稳定性
  - 新增功能向后兼容
  - 配置向后兼容

### 浏览器兼容性

- 🌐 **Go版本要求**
  - Go 1.18+ (泛型支持)
  - 向后兼容：Go 1.15+

---

**维护信息**

- **当前版本**: v2.0.0
- **下一个版本**: v2.1.0 (计划: 2026-03-01)
- **发布周期**: 3个月一次
- **支持周期**: 当前版本 + 2个版本

---

**最后更新**: 2025-12-23
**审核状态**: 已通过
**维护者**: VineRoute Backend Team